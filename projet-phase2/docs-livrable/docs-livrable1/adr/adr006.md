# ADR-006 — API Gateway, Load Balancing & Sécurité périmétrique

**Statut**: Accepté

## Contexte
La phase 2 doit démontrer le passage d’un accès direct au monolithe vers un accès orchestré par une API Gateway (Kong/KrakenD/Spring Cloud Gateway) avec load balancing (Traefik/NGINX/HAProxy) et politiques de sécurité cohérentes (CORS, quotas, authentification centralisée). Les tests de charge doivent comparer les performances (latence, débit, erreurs) entre les modes direct et Gateway. En phase 1, l’application exposait des endpoints `/internal/*` sans couche périmétrique ni routage dynamique.

## Décision
1. **Adopter une API Gateway configurable** :
   - Utiliser Spring Cloud Gateway (par défaut) ou Kong/KrakenD selon environnement, versionnées dans `docker-compose`.
   - Configurer routes `/api/v1/**` vers le monolithe, avec support pour plusieurs instances (`api-1`, `api-2`, etc.).
2. **Load balancing & tolérance aux pannes** :
   - Traefik/NGINX en frontal (optionnel) ou load balancing intégré à la Gateway avec round-robin.
   - Health-checks agressifs (intervalle 5 s) et stratégie de retrait automatique des instances défaillantes.
   - Scripts de chaos (`tests/perf/kill-instance.sh`) pour démontrer la résilience pendant une charge k6.
3. **Sécurité périmétrique** :
   - CORS maîtrisé (`allowedOrigins` configurable), en-têtes de sécurité (HSTS, X-Content-Type-Options).
   - Authentification centralisée (Basic/JWT) et propagation du `Authorization` vers l’API.
   - Rate limiting/quotas et clés API (pour clients externes) via Gateway.
4. **Traçabilité & observabilité** :
   - Génération d’un `X-Trace-Id` unique à l’entrée Gateway, propagation vers l’API et les logs (cf. ADR-004/005).
   - Exposition des métriques Gateway (`/actuator/prometheus` ou plugins) pour comparer latence directe vs Gateway.
5. **Comparaison de performances** :
   - Scripts k6 orchestrant les scénarios directs vs Gateway (N=1..4 instances) et collectant dashboards comparatifs.
   - Documents de synthèse (rapport phase 2) avec graphiques latence/RPS/erreurs et impact du load balancing.

## Conséquences
- **Sécurité accrue** : contrôle centralisé des accès, gestion des quotas et des origines.
- **Scalabilité** : possibilité d’ajouter/supprimer des instances sans reconfigurer les clients.
- **Complexité** : infrastructure plus riche (Gateway + LB), nécessitant configuration/monitoring supplémentaire.
- **Documentation** : nécessite un runbook détaillant la configuration Gateway, les commandes de déploiement et les scénarios de tests (k6, chaos). Les contrats OpenAPI servent de source pour la Gateway (spec-first).
