# ADR-005 — Observabilité avancée & Golden Signals

**Statut**: Accepté

## Contexte
La phase 2 exige des preuves chiffrées d’amélioration sur les 4 Golden Signals (latence, trafic, erreurs, saturation) et la capacité de diagnostiquer rapidement les anomalies pendant les tests de charge (k6/JMeter) et la comparaison direct API vs API Gateway. La phase 1 offrait uniquement des logs applicatifs et un endpoint `/metrics` minimal, insuffisant pour :

- Mesurer et comparer les scénarios (monolithe seul, load balanced, via Gateway).
- Corréler événements métier (exécution d’ordre, notification) avec traceId commun.
- Exposer des dashboards reproductibles (Grafana) à remettre en livrable.

## Décision
1. **Instrumentation Micrometer/Prometheus** :
   - Activation Spring Actuator + Micrometer Prometheus (`/actuator/prometheus`) avec histogrammes P95/P99 sur endpoints clés.
   - Métriques custom : `brokerx.matching.latency`, `brokerx.orders.submitted`, `brokerx.notifications.delivered`, `brokerx.market.tickLatency`.
2. **Dashboards Grafana versionnés** :
   - Stockage des JSON de dashboards dans `docs/architecture/observability/` (Golden Signals, matching, notifications).
   - Pipeline CI exportant captures/rapports prêts à l’usage.
3. **Logs structurés corrélés** :
   - Format JSON (`traceId`, `spanId`, `userId`, `uc`, `durationMs`, `status`) via `RequestLoggingFilter`.
   - Intégration possible avec Loki/ELK (non obligatoire mais documentée).
4. **Traces / corrélations** :
   - Propagation `traceId` & `spanId` (header `X-Trace-Id` généré par Gateway, fallback UUID).
   - Couverture dans audit (voir ADR-004) et dans métriques (tag `traceId` pour matching/notifications).
5. **Tests de charge automatisés** :
   - Scripts k6 orchestrant les scénarios UC Must (dépendances `tests/perf/`).
   - Export des résultats (JSON, CSV) et comparaison avant/après (monolithe vs Gateway/LB) via `tests/perf/reports`.

## Conséquences
- **Visibilité** : équipes Ops/étudiants disposent de dashboards et métriques normalisées pour démontrer les gains phase 2.
- **Coût** : instrumentation et export métriques augmentent légèrement la charge CPU/mémoire (accepté). Il faut maintenir les dashboards versionnés.
- **Processus** : toute nouvelle route/UC doit ajouter des métriques et logs cohérents ; la pipeline CI doit valider la disponibilité de `/actuator/health` et `/actuator/prometheus`.
- **Préparation** : facilite la future découpe microservices (Prometheus + traceId déjà en place).
