<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>BrokerX Prototype</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f6fa; margin:0; padding:32px; }
    h1 { margin-bottom: 16px; }
    section { background:#fff; border-radius:8px; padding:24px; margin-bottom:24px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    label { display:block; margin-bottom:4px; font-weight:bold; }
    input { width:100%; padding:8px; margin-bottom:12px; border:1px solid #ccc; border-radius:4px; }
    button { padding:10px 16px; background:#0069d9; border:none; color:#fff; border-radius:4px; cursor:pointer; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    .log { font-family: "SFMono-Regular", Consolas, monospace; background:#1e1e1e; color:#e2e2e2; padding:16px; border-radius:8px; min-height:120px; overflow:auto; }
    .status-ok { color:#2d8a34; font-weight:bold; }
    .status-error { color:#b33a3a; font-weight:bold; }
  </style>
</head>
<body>
  <h1>BrokerX – Prototype Phase 1</h1>
  <p>Ce mini tableau de bord permet d’exécuter les trois UC Must : authentification, dépôt virtuel et placement d’un ordre.</p>

  <section>
    <h2>1. Authentification & Session</h2>
    <label for="login-email">Courriel</label>
    <input id="login-email" type="email" value="seed@brokerx.dev" />
    <label for="login-password">Mot de passe</label>
    <input id="login-password" type="password" value="password123" />
    <label for="login-otp">OTP (MFA)</label>
    <input id="login-otp" type="text" value="123456" />
    <button onclick="authenticate()">Se connecter</button>
    <p id="login-status"></p>
  </section>

  <section>
    <h2>2. Dépôt virtuel</h2>
    <label for="deposit-account">Account ID</label>
    <input id="deposit-account" type="text" value="11111111-1111-1111-1111-111111111111" />
    <label for="deposit-amount">Montant</label>
    <input id="deposit-amount" type="number" value="100" />
    <label for="deposit-idem">Clé d’idempotence</label>
    <input id="deposit-idem" type="text" value="demo-ui-1" />
    <button onclick="deposit()">Effectuer le dépôt</button>
    <p id="deposit-status"></p>
  </section>

  <section>
    <h2>3. Placement d’un ordre</h2>
    <label for="order-account">Account ID</label>
    <input id="order-account" type="text" value="11111111-1111-1111-1111-111111111111" />
    <label for="order-symbol">Symbole</label>
    <input id="order-symbol" type="text" value="AAPL" />
    <label for="order-qty">Quantité</label>
    <input id="order-qty" type="number" value="10" />
    <label for="order-type">Type (MARKET/LIMIT)</label>
    <input id="order-type" type="text" value="MARKET" />
    <label for="order-price">Prix limite (optionnel)</label>
    <input id="order-price" type="number" placeholder="laisser vide pour MARKET" />
    <label for="order-side">Sens (BUY/SELL)</label>
    <input id="order-side" type="text" value="BUY" />
    <label for="order-client-id">clientOrderId</label>
    <input id="order-client-id" type="text" value="demo-order-ui-1" />
    <button onclick="placeOrder()">Placer l’ordre</button>
    <p id="order-status"></p>
  </section>

  <section>
    <h2>Journal</h2>
    <div id="log" class="log"></div>
  </section>

  <script>
    const logBox = document.getElementById('log');

    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString();
      const line = document.createElement('div');
      line.textContent = `[${time}] ${message}`;
      if (type === 'error') {
        line.style.color = '#ff8a80';
      } else if (type === 'success') {
        line.style.color = '#80ff8a';
      }
      logBox.appendChild(line);
      logBox.scrollTop = logBox.scrollHeight;
    }

    async function authenticate() {
      const payload = {
        email: document.getElementById('login-email').value,
        password: document.getElementById('login-password').value,
        otp: document.getElementById('login-otp').value
      };
      await callEndpoint('/internal/auth/login', payload, 'login-status', data => `sessionId=${data.sessionId}`);
    }

    async function deposit() {
      const payload = {
        accountId: document.getElementById('deposit-account').value,
        amount: Number(document.getElementById('deposit-amount').value),
        idempotencyKey: document.getElementById('deposit-idem').value
      };
      await callEndpoint('/internal/deposits', payload, 'deposit-status', data => `Nouveau solde = ${data.newBalance}`);
    }

    async function placeOrder() {
      const payload = {
        accountId: document.getElementById('order-account').value,
        side: document.getElementById('order-side').value.toUpperCase(),
        type: document.getElementById('order-type').value.toUpperCase(),
        symbol: document.getElementById('order-symbol').value.toUpperCase(),
        qty: Number(document.getElementById('order-qty').value),
        limitPrice: document.getElementById('order-price').value ? Number(document.getElementById('order-price').value) : null,
        clientOrderId: document.getElementById('order-client-id').value
      };
      await callEndpoint('/internal/orders', payload, 'order-status', data => `orderId=${data.orderId} status=${data.status}`);
    }

    async function callEndpoint(path, payload, statusElementId, successFormatter) {
      try {
        const res = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const body = await res.json();
        if (res.ok) {
          const message = successFormatter(body);
          document.getElementById(statusElementId).innerHTML = `<span class="status-ok">OK</span> ${message}`;
          log(`${path} → ${message}`, 'success');
        } else {
          document.getElementById(statusElementId).innerHTML = `<span class="status-error">${body.code || 'ERROR'}</span> ${body.message}`;
          log(`${path} KO (${body.code}): ${body.message}`, 'error');
        }
      } catch (err) {
        document.getElementById(statusElementId).innerHTML = `<span class="status-error">Erreur réseau</span>`;
        log(`${path} KO: ${err}`, 'error');
      }
    }
  </script>
</body>
</html>
